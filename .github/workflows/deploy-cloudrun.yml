name: Deploy to Cloud Run

on:
  workflow_dispatch:
  push:
    branches: ["main"]

concurrency:
  group: cloudrun-production
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: suahkim-dev
  REGION: asia-southeast1
  AR_REPO: suahkim-repo

  SERVICE_BACKEND: suahkim-backend
  SERVICE_FRONTEND: suahkim-frontend

  IMAGE_BACKEND: suahkim-backend
  IMAGE_FRONTEND: suahkim-frontend

jobs:
  deploy_backend:
    runs-on: ubuntu-latest
    outputs:
      backend_url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - uses: docker/setup-buildx-action@v3

      - name: Build and push backend image (sha)
        env:
          IMAGE_URI: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_BACKEND }}:${{ github.sha }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -f Dockerfile \
            -t "${IMAGE_URI}" \
            --push \
            .

      - id: deploy
        name: Deploy backend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          project_id: ${{ env.PROJECT_ID }}
          region: ${{ env.REGION }}
          service: ${{ env.SERVICE_BACKEND }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_BACKEND }}:${{ github.sha }}
          env_vars: |
            BACKEND_PORT=8080
          env_vars_update_strategy: merge
          flags: |
            --memory=512Mi
            --cpu=1
            --cpu-throttling
            --concurrency=100
            --min-instances=0
            --max-instances=10
            --timeout=300

  deploy_frontend:
    runs-on: ubuntu-latest
    needs: deploy_backend
    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Rewrite nginx.conf to target deployed backend URL
        env:
          BACKEND_URL: ${{ needs.deploy_backend.outputs.backend_url }}
        run: |
          python - <<'PY'
          import os
          import re
          from pathlib import Path

          backend_url = os.environ["BACKEND_URL"].strip()
          if not backend_url.startswith(("http://", "https://")):
            raise SystemExit(f"BACKEND_URL does not look like a URL: {backend_url!r}")
          p = Path("nginx.conf")
          s = p.read_text()

          pattern = r'(?m)^(\s*)proxy_pass\s+[^;]+;'
          s2, n = re.subn(pattern, rf'\1proxy_pass {backend_url};', s)
          if n == 0:
            raise SystemExit("No proxy_pass directives were updated in nginx.conf; refusing to build a broken frontend image.")
          p.write_text(s2)
          PY

      - name: Verify nginx.conf proxy_pass values
        run: |
          echo "proxy_pass lines after rewrite:"
          grep -n "proxy_pass" nginx.conf || true

      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - uses: docker/setup-buildx-action@v3

      - name: Build and push frontend image (sha)
        env:
          IMAGE_URI: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_FRONTEND }}:${{ github.sha }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -f web.Dockerfile \
            -t "${IMAGE_URI}" \
            --push \
            .

      - name: Deploy frontend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          project_id: ${{ env.PROJECT_ID }}
          region: ${{ env.REGION }}
          service: ${{ env.SERVICE_FRONTEND }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_FRONTEND }}:${{ github.sha }}
          env_vars: |
            API_URL=${{ needs.deploy_backend.outputs.backend_url }}
          env_vars_update_strategy: merge
          flags: |
            --memory=256Mi
            --cpu=1
            --cpu-throttling
            --concurrency=100
            --min-instances=0
            --max-instances=10
            --timeout=300

